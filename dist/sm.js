!function(root,factory){"function"==typeof define&&define.amd?define([],factory):"object"==typeof module&&module.exports?module.exports=factory():root.sm=factory()}(this,function(){"use strict";var TOP_STATE_NAME="TOP",SEP=".",TRIGGERLESS="next",INITIAL="initial",FINAL="final",TARGET="target",GUARD="guard",EFFECT="effect",STEADY="steady";function State_(name,definition,parent){this.name=name,this.definition=definition,this.parent=parent,this.initial=null,this.isComposite=null,this.isFinal=null,this.isInitial=null,this.isSteady=null,this.triggerless=[]}function StateMachineInstanceData_(host,state){this.host=host,this.state=state}function StateMachineClassData_(){this.states={}}function StateMachine(host){var privateData=new StateMachineInstanceData_(host,this.constructor.compiledDef.states[TOP_STATE_NAME]);this._=privateData}function defSM(definition){if(!isObject_(definition))throw new Error(Errors.ILLEGAL_ARGUMENT.toString("Make sure the 'definition' argument is an object."));var StateMachineClass=function StateMachineClass(host){if(!isObject_(host))throw new Error(Errors.ILLEGAL_ARGUMENT.toString("Make sure the 'host' argument is provided."));var sm;if(this&&this.isSMConstructed)throw new Error(Errors.ILLEGAL_ARGUMENT.toString("Make sure 'this' is not an already constructed state machine."));return sm=Object.create(StateMachineClass.prototype),Object.defineProperty(sm,"isSMConstructed",{value:!0,writeable:!1,enumerable:!1}),StateMachine.apply(sm,arguments),sm};StateMachineClass.def=definition;var smData=new StateMachineClassData_;return smData.processDefinition(TOP_STATE_NAME,"",definition,null),StateMachineClass.compiledDef=smData,extend_(StateMachineClass,StateMachine),StateMachineClass}function proceeed_(sm,commonOwner,trigger){for(var host=sm._.host,state=sm._.state,smClass=sm.constructor,transitions=findTransitions_(state,commonOwner,trigger),isLeft=!1,i=0;i<transitions.length;i++){var t=transitions[i];if(isNothing_(t[GUARD])||execute_(host,t[GUARD],sm)){var target=smClass.compiledDef.states[t[TARGET]];if(isNothing_(target))throw new Error(Errors.RUNTIME_ERROR.toString("Make sure the 'target' property ("+t.target+") points to an existing state."));isLeft=!0;for(var newCommonOwner=getCommonOwner_(state,target),exitArr=getExitActions_(state,newCommonOwner),entryArr=getEntryActions_(target,newCommonOwner),ex=0;ex<exitArr.length;ex++)execute_(host,exitArr[ex],sm);execute_(host,t[EFFECT],sm);for(var en=0;en<entryArr.length;en++)execute_(host,entryArr[en],sm);sm._.state=target,proceeed_(sm,newCommonOwner,null);break}}if(!isLeft&&!state.isSteady)throw new Error(Errors.RUNTIME_ERROR.toString("Make sure the state machine never stops (completes) in a not steady state, such as: "+state.name))}function findTransitions_(state,commonOwner,trigger){if(state.isComposite)return[{target:state.initial.name}];var transitions=[];if(isNothing_(trigger))for(;null!=state&&state!=commonOwner;state=state.parent)Array.prototype.push.apply(transitions,state.triggerless);else for(;null!=state;state=state.parent)isNothing_(state.definition[trigger])||transitions.push(state.definition[trigger]);return transitions}function getCommonOwner_(state1,state2){for(var s1=state1;null!=s1;s1=s1.parent)for(var candidate=s1,s2=state2;null!=s2;s2=s2.parent)if(s2===candidate)return s2;return null}function getExitActions_(s,owner){for(var actions=[];s!=owner;s=s.parent)isNothing_(s.definition.exit)||actions.push(s.definition.exit);return actions}function getEntryActions_(s,owner){for(var actions=[];s!=owner;s=s.parent)isNothing_(s.definition.entry)||actions.splice(0,0,s.definition.entry);return actions}function execute_(host,func,sm){if(!isNothing_(func))return"function"==typeof func?func.call(host,sm):host[func].call(host,sm)}function extend_(Sub,Base){Sub.prototype=Object.create(Base.prototype),(Sub.prototype.constructor=Sub).super$=Base}StateMachineClassData_.prototype.processDefinition=function(name,defKey,definition,parent){var state=new State_(name,definition,parent);defKey!==INITIAL||isNothing_(parent)||(parent.initial=state),this.states[name]=state;var isComposite=!1,isSteadyFlagSet=!1,steadyFlag=null,numInitial=0,numFinal=0,hasTransitions=!1;for(var key in definition){var value=definition[key];if((key=key.trim())===TRIGGERLESS){if(!isObject_(value)&&!isArray_(value))throw new Error(Errors.ILLEGAL_DESIGN.toString("The "+TRIGGERLESS+" property for state "+state.name+" should either be a transition object or an array of transition objects."));if(isArray_(value))for(var i=0;i<value.length;i++){if(isNothing_(value[i][TARGET]))throw new Error(Errors.ILLEGAL_DESIGN.toString("Make sure triggerless transitions all have 'target' property. State: "+state.name));state.triggerless.push(value[i])}else{if(isNothing_(value[TARGET]))throw new Error(Errors.ILLEGAL_DESIGN.toString("Make sure triggerless transitions all have 'target' property. State: "+state.name));state.triggerless.push(value)}hasTransitions=!0}else key===STEADY?(isSteadyFlagSet=!0,steadyFlag=!!value):isObject_(value)&&(isNothing_(value[TARGET])?(isComposite=!0,key===INITIAL&&numInitial++,key===FINAL&&numFinal++,this.processDefinition(name+SEP+key,key,value,state)):hasTransitions=!0)}if(state.isComposite=isComposite,state.isFinal=defKey===FINAL,state.isInitial=defKey===INITIAL,state.isFinal&&hasTransitions)throw new Error(Errors.ILLEGAL_DESIGN.toString("Make sure final states don't have transitions of their own. State: "+state.name));if(state.isComposite&&(state.isFinal||state.isInitial))throw new Error(Errors.ILLEGAL_DESIGN.toString("Make sure initial and final states like "+state.name+" are not composite."));if(state.isInitial&&0===state.triggerless.length)throw new Error(Errors.ILLEGAL_DESIGN.toString("Make sure the initial state "+state.name+" has at least one outgoing triggerless transition."));if(state.isFinal&&0<state.triggerless.length)throw new Error(Errors.ILLEGAL_DESIGN.toString("Make sure the final state "+state.name+" has no outgoing transitions at all."));if(state.isFinal&&(state.triggerless=parent.triggerless),state.isComposite&&1!==numInitial)throw new Error(Errors.ILLEGAL_DESIGN.toString("Make sure composite state "+state.name+" has exactly one initial state."));if(state.isComposite&&1<numFinal)throw new Error(Errors.ILLEGAL_DESIGN.toString("Make sure composite state "+state.name+" has at most one final state."));if(isSteadyFlagSet){if(steadyFlag){if(state.isInitial||state.isComposite)throw new Error(Errors.ILLEGAL_DESIGN.toString("Make sure composite and initial states are never steady. State: "+state.name))}else if(state.isFinal)throw new Error(Errors.ILLEGAL_DESIGN.toString("Make sure final states are always steady. State: "+state.name));state.isSteady=steadyFlag}else state.isSteady=!state.isComposite&&!state.isInitial},StateMachine.prototype.init=function(){proceeed_(this,null,null)},StateMachine.prototype.getState=function(){return this._.state.name},StateMachine.prototype.process=function(trigger){if(!isString_(trigger)||0===trigger.trim().length)throw new Error(Errors.ILLEGAL_ARGUMENT.toString("Make sure the 'trigger' argument is a non-empty string."));proceeed_(this,null,trigger)};var isArray_=function(){if(Array.isArray)return Array.isArray;var objectToStringFn=Object.prototype.toString,arrayToStringResult=objectToStringFn.call([]);return function(subject){return objectToStringFn.call(subject)===arrayToStringResult}}();function isNothing_(obj){return null==obj}function isNumber_(obj){return"number"==typeof obj}function isObject_(obj){return obj&&"object"==typeof obj&&!isArray_(obj)}function isString_(obj){return"string"==typeof obj}function ErrorMessage_(code,desc){if(!isNumber_(code))throw new Error(Errors.ILLEGAL_ARGUMENT.toString("Make sure code is a number."));if(!isString_(desc))throw new Error(Errors.ILLEGAL_ARGUMENT.toString("Make sure desc is a string."));this.code=code,this.desc=desc}ErrorMessage_.prototype.toString=function(var_args){for(var desc=this.desc,i=0;i<arguments.length;i++)desc=desc.replace("$"+(i+1),arguments[i]);return"Oops! "+desc+" (#"+this.code+")"};var Errors={ILLEGAL_ARGUMENT:new ErrorMessage_(3e3,"Illegal argument(s). $1"),ILLEGAL_DESIGN:new ErrorMessage_(3001,"Illegal design of state machine. $1"),RUNTIME_ERROR:new ErrorMessage_(3002,"Runtime error. $1")};return{defSM:defSM}});